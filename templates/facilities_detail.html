{% extends "base.html" %}

{% block title %}{{ facility.name }} Detail{{ block.super }}{% endblock %}

{% block stylesheets %}
{{ block.super }}
    <link type="text/css" rel="stylesheet" href="/static/ilsgateway/stylesheets/ilsgateway.css" />
{% endblock %}

{% block content %}
<div class="crumbs">{% for title, href in breadcrumbs %}{% if not forloop.first %} &raquo; {% endif %}{% if href %}<a href="{{href}}">{{ title }}</a>{% else %}{{ title }}{% endif %}{% endfor %}</div>
<div style="clear:both;">&nbsp;</div>

<div class="split-2">
    <div class="left">
        <div class="module">
            <h2>Inventory History</h2>
            <div class="toolbar">
                {% if view_type == 'inventory' %}<a href="/facilities/{{ facility.id }}/months_of_stock/">show months of stock</a>
                {% else %}<a href="/facilities/{{ facility.id}}/inventory/">show stock levels</a>{% endif %}
            </div>
            <div class="inventorySMS">
                <p>Last SMS message received:</p>
            {% if facility.last_message_received %}
                <p><i>&raquo;"{{ facility.last_message_received.text }}"</i></p>
                <p>{{ facility.stock_on_hand_last_reported }} by {{ facility.last_message_received.contact.contactdetail.role }} {{ facility.last_message_received.contact }}</p>
            {% else %}
                <p>No inventory messages have been received</p>
            {% endif %}    
            <p><a href="/facilities/{{ facility.id }}/message_history/">See complete SMS message history &raquo;</a></p>
            </div>
            <table>
                <thead>
                    <th>Product</th>
                    <th>{% if view_type == 'inventory' %}Stock on Hand{% else %}Months of Stock{% endif %}</th>
                </thead>
                <tbody>
                {% for product, quantity in product_counts %}
                    <tr><td>{{ product }}</td><td><span class="{% if quantity == 0 %}zero_count{% else %}{% if not quantity %}insufficient_data{% endif %}{% endif %}">{% if quantity == None %}no data{% else %}{{quantity}}{% endif %}</span></td></tr>    
                {% endfor %}                
                </tbody>
            </table>            
        </div>    
        <div class="module">
            <h2 class="contactGroup">{{ facility.name }} ({{ facility.msd_code }}) Group {{ facility.delivery_group.name }}</h2>
            <div class="toolbar">
                <a href="{% url locations facility.uid %}">see on map</a>
            </div>
            {% for group_name, contacts in contact_groups %}
            <div class="contactGroupHeader">{{ group_name }} Contacts</div>
            <table>
                <thead>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Primary</th>
                </thead>
                <tbody>
                    {% for contact in contacts %}
                    <tr class="">
                        <td>{{ contact.name }}</td>
                        <td>{{ contact.role }}</td>
                        <td>{{ contact.phone }}</td>
                        <td>{{ contact.email }}</td>
                        <td><input type="checkbox" checked="{{ contact.primary }}" readonly="readonly" /></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endfor %}
            <br />
            <span style="margin-top:10px;"><a href="{% url registration %}">Add a contact &raquo;</a></span>
        </div>
    </div>
    <div class="right">
        <div class="module">
            <h2>R &amp; R History</h2>
            <div class="toolbar">
                <a href="">see all R&amp;R history</a>
            </div>
            {% if facility.randr_status %}
            <p>
                Status: <span class="{{ facility.randr_status.status_type.short_name }}">{{ facility.randr_status }}</span>
            </p>
            <p>
                Last updated on: <span class="{{ facility.randr_status.status_type.short_name }}">{{ facility.randr_status.status_date }}</span>
            </p>
            {% else %}
            <p>
                 <span class="no_delivery_status_reported">No delivery status reported</a>
            </p>
            {% endif %}
            </p>
            <p><a href="/docdownload/{{ facility.id }}">Download most recent R&amp;R &raquo;</a></p>
        </div>
        <div class="module">
            <h2>Notes</h2>
            <div class="toolbar">
                <a href="{% url ilsgateway.views.note_history facility.id %}">see all notes</a>
            </div>
        {% for note in notes %}
            <div class="recentNote">
                <p class="noteText">&raquo; "{{ note.text }}"</span></p>
                <p class="noteByLine">{{ note.created_at }} by {{ note.contact_detail.name }}
            </div> 
        {% endfor %}
            <form action="{% url ilsgateway.views.facilities_detail facility.id %}" method="post">
            <p>Enter a note for this facility:</p>
            {{ form.as_p }}
            <input type="submit" value="Submit" />
            </form>
        </div>
    </div>
</div>
{% endblock %}